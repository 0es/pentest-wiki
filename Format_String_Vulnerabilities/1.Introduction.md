1. Introduction

This article explains the nature of a phenomenon that has shocked the security community in the second half of the year 2000. Known as 'format string vulnerabilities', a whole new class of vulnerabilities has been disclosed and caused a wave of exploitable bugs being discovered in all kinds of programs, ranging from small utilities to big server applications.

The article will try to explain the structure of the vulnerability and later use this knowledge to build sophisticated exploits. It will show you how to discover format string vulnerabilities in C source code, and why this new kind of vulnerability is more dangerous than the common buffer overflow vulnerability.

The article is based on a german speech I gave at the 17th Chaos Communication Congress in Berlin, Germany. After the speech I got numerous requests to translate it and received a lot of positive feedback. All this motivated me to revise the document, update and correct details and to do a more useable LATEX version of it.

This article covers most of the things mentioned in other articles, plus a few more tricks and twirks when it comes to exploitation. It is up to date yet, and feedback is welcome. So after you have read it please send me feedback, ideas and anything else non-harassive to scut@team-teso.net.

The first part of the article deals with the history and awareness of format string vulnerabilities, followed by details how to discover and avoid such vulnerabilities in source code. Then some basic techniques are developed to play with this vulnerabilities, from which a mighty exploitation method arises. This method is then modified, improved and practically applied for special situations to allow you to exploit nearly any kind of format string vulnerability seen until today.

As with every vulnerability it was developed over time, and new techniques have shown up, often because old ones did not work in a certain situation. People, who truly deserve for a lot of techniques mentioned in this articles and have influenced my writing significantly are utf8, who wrote the first format string exploit ever, portal, who developed and researched exploitablity in his excellent article, DiGiT, who found most of the critical remote format string vulnerabilities known today, and smiler, who developed sophisticated brute force techniques.

Although I have contributed some tricks too, without the giant help, comments and tricks - both theoretically or in form of an exploit - shown to me by this people, this article would not have been possible. Thanks. I also thank the numerous individuals who commented, reviewed and improved this article.

Updated and corrected versions may appear on the TESO Security Group homepage.


1.1 Buffer Overflow vs. Format String Vulnerabilities

Since nearly all critical vulnerabilities in the past were some kind of buffer overflows, one compare such a serious and low level vulnerability to this new type of vulnerabilities.

|                       | *Buffer Overflow* | *Description* |
|:----------------------|:------------------|:--------------|
| public since danger realized number of exploits considered as techniques visibility |  mid 1980's 1990's a few thousand security threat evolved and advanced sometimes very difficult to spoy | June 1999, June 2000 , a few dozen programming bug basic techniques easy to find |


1.2 Statistics: important format string vulnerabilities in 2000

To underline the dangerous impact format string vulnerabilities had for the year 2000, we list the most exploited publicized vulnerabilities here.

| Application | Found by | Impact | years |
|:------------|:---------|:-------|:------|
| wu-ftpd 2.* | security.is | remote root | > 6 |
| Linux rpc.statd | security.is | remote root | > 4 |
| IRIX telnetd | LSD | remote root | > 8 |
| Qualcomm Popper 2.53 | security.is | remote user | > 3 |
| Apache + PHP3 | security.is | remote user | > 2 |
| NLS / locale | CORE SDI | local root | ? |
| screen | Jouko Pynnonen | local root | > 5 |
| BSD chpass | TESO | local root | ? |
| OpenBSD fstat | ktwo | local root | ? |

There are still a lot of unknown or vulnerabilities left at the time of writing, and for the next two or three years format string vulnerabilities will contribute to the statistics of new vulnerabilities that are found. As we will see, they are easy to discover automatically with more sophisticated tools, and you can assume that for most of the vulnerabilities in todays code which are not yet publicly known, an exploit already exist.

There are also ways to discover this type of vulnerability in applications, that are available as binaries only. To do this a more generic approach to find 'argument deficiencies' is used and explained in detail in Halvar Flakes excellent binary auditing speech.

