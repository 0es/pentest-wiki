2. The Format Functions

A format function is a special kind of ANSI C function, that takes a variable number of arguments, from which one is the so called format string. While the function evaluates the format string, it accesses the extra parameters given to the function. It is a conversion function, which is used to represent primitive C data types in a human readable string representation. They are used in nearly any C program, to output information, print error messages or process strings.

In this chapter we will cover typical vulnerabilities in the usage of format functions, the corrent usage, some of their parameters and the general concept of a format string vulnerability.

2.1 How does a format string vulnerability look like ?

If an attack is able to provide the format string to an ANSI C format function in part or as a whole, a format string vulnerability is present. By doing so, the behaviour of the format function is changed, and the attacker may get control over the target application. 

In the examples below, the string **user** is supplied by the attacker -- he can control the entire ASCIIZ-string, for example through using a command line parameter.

Wrong usage:

```
int func (char *user)
{
        printf(user);
		return 0;
}

int main(int argc, char **argv)
{
        func(argv[1]);
		return 0;
}
```

Ok:

```
int func (char *user)
{
        printf("%s", user);
		return 0;
}
```


2.2 The format function family

A number of format functions are defined in the ANSI C definition. There are some basic format string functions on which more complex functions are based on, some of which not part of the standard but are widely available.

Real family members:

- fprintf - prints to a FILE stream
- printf - prints to the 'stdout' stream
- sprintf - prints into a string
- snprintf - prints into a string with length checking
- vfprintf - prints to a FILE stream from a va_arg structure
- vprintf - prints to 'stdout' from a va_arg structure
- vsprintf - prints to a string from a va_arg structure
- vsnprintf - prints to a string with length checking from a va_arg structure

Relatives:

- setproctitle - set argv[]
- syslog - output to the syslog facility
- others like err\*, verr\*, warn\*, vwarn\*


2.3 Use of format functions

To understand where this vulnerability is common in C code, we have to examine the purpose of format functions.

Functionality

- used to convert simple C datatypes to a string representation
- allow to specify the format of the representation
- process the resulting string (output to stderr, stdout, syslog, ...)

How the format function works

- the format string controls the behaviour of the function
- it specifies the type of parameters that should be printed
- parameters are saved on the stack (pushed)
- saved either directly (by value), or indirectly (by reference)

The calling function

- has to know how many parameters it pushes to the stack, since it has to do the stack correction, when the format function returns.


2.4 What exactly is a format string ?

A format string is an ASCIIZ string that contains text and format parameters. Example:

  ```printf("The magic number is: %d\n", 1911);```

The text to be printed is "The magic number is:", followed by a format parameter '%d', that is replaced with the parameter (1911) in the output. Therefore the output looks like: **The magic number is: 1911.**


| parameter | output | passed as |
|:----------|:-------|:----------|
| %d | decimal (int) | value |
| %u | unsigned decimal (unsigned int)    | value |
| %x | hexadecimal (unsigned int) | value | value |
| %s | string ((const) (unsigned) char *) | reference |
| %n | number of bytes written so far, (* int) | reference | 

The '\' character is used to escape special characters. It is replaced by the C compile-time, replacing the escape sequence by the appropiate character in the binary. The format functions do not recognize those special sequences. In fact, they do not have anything to do with the format functions at all, but are sometimes mixed up, as if they are evaluated by them.


2.5 The stack and its role at format strings

The behaviour of the format function is controlled by the format string. The function retrieves the parameters requested by the format string from the stack.

  
    printf("Number %d has no address, number %d has: %08x\n", i, a, &a);

From within the **printf** function the stack looks like:

    ------------    --------  stack top
	| ...      |
	| <&a>     | <---- Address of the format string
	| <a>      | <---- value of the variable a
	| <i>      | <---- value of the variable i
	| A        | <---- Address of the format string
	| ...      |
	------------    --------  stack bottom


The format function now parses the format string 'A', by reading a character a time. If it is not '%', the character is copied to the output. In case it is, the character behind the '%' specifiesthe type of parameter that should be evaluated. The string "%%" has a special meaning, it is used to print the escape character '%' itself. Every other parameter relates to data, which is located on the stack.

